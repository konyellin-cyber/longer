# KV Cache ä¼˜åŒ–æ–¹æ¡ˆç¤ºæ„å›¾

## åœºæ™¯æè¿°

åœ¨æ¨èç³»ç»Ÿä¸­ï¼Œè¾“å…¥åºåˆ—ç»“æ„å¦‚ä¸‹ï¼š
- ç¬¬ä¸€ä¸ªä½ç½®ï¼šTarget Itemï¼ˆç›®æ ‡å•†å“ï¼‰
- åç»­ä½ç½®ï¼šUserç²’åº¦çš„å†å²æ•°æ®
- ä½¿ç”¨**æ— å‘ Self-Attention**ï¼šæ¯ä¸ªä½ç½®å¯ä»¥çœ‹åˆ°æ‰€æœ‰å…¶ä»–ä½ç½®

## ä¼˜åŒ–æ ¸å¿ƒæ€è·¯

1. åœ¨ User ç²’åº¦è®¡ç®—åç»­ token çš„ KV Cacheï¼ˆç‹¬ç«‹äº Target Itemï¼‰
2. å°†è®¡ç®—ç»“æœå¹¿æ’­åˆ° Doc ç²’åº¦ï¼ˆæ¯ä¸ªå€™é€‰å•†å“ï¼‰
3. é¿å…é‡å¤è®¡ç®—ï¼Œæå‡åå

## æ¨ç†æµç¨‹å¯¹æ¯”

```mermaid
graph TB
    subgraph "ä¼ ç»Ÿæ–¹æ¡ˆï¼ˆååé™å¹…40%ï¼‰"
        A1["Target Item 1"] --> B1["User å†å² Token"]
        B1 --> C1["è®¡ç®— Attention"]
        C1 --> D1["ç”Ÿæˆè¾“å‡º 1"]
        
        A2["Target Item 2"] --> B2["User å†å² Token"]
        B2 --> C2["è®¡ç®— Attention<br/>é‡å¤è®¡ç®—ï¼âŒ"]
        C2 --> D2["ç”Ÿæˆè¾“å‡º 2"]
        
        A3["Target Item 3"] --> B3["User å†å² Token"]
        B3 --> C3["è®¡ç®— Attention<br/>é‡å¤è®¡ç®—ï¼âŒ"]
        C3 --> D3["ç”Ÿæˆè¾“å‡º 3"]
        
        style C1 fill:#ff9999
        style C2 fill:#ff6666
        style C3 fill:#ff6666
    end
    
    subgraph "ä¼˜åŒ–æ–¹æ¡ˆï¼ˆååé™å¹…6.8%ï¼‰"
        E["User ç²’åº¦è®¡ç®—<br/>ï¼ˆåªæ‰§è¡Œä¸€æ¬¡ï¼‰"] --> F["ç”¨æˆ·å†å²çš„ KV Cache"]
        F --> G["å¹¿æ’­åˆ° Doc ç²’åº¦"]
        
        G --> H1["Target Item 1<br/>+ ç”¨æˆ· KV Cache"]
        G --> H2["Target Item 2<br/>+ ç”¨æˆ· KV Cache"]
        G --> H3["Target Item 3<br/>+ ç”¨æˆ· KV Cache"]
        
        H1 --> I1["ç”Ÿæˆè¾“å‡º 1"]
        H2 --> I2["ç”Ÿæˆè¾“å‡º 2"]
        H3 --> I3["ç”Ÿæˆè¾“å‡º 3"]
        
        style E fill:#99ff99
        style F fill:#99ff99
        style G fill:#99ff99
    end
```

## è¯¦ç»†æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as Userç²’åº¦è®¡ç®—
    participant Cache as KV Cache
    participant Doc1 as Docç²’åº¦<br/>Target1
    participant Doc2 as Docç²’åº¦<br/>Target2
    participant Doc3 as Docç²’åº¦<br/>Target3

    User->>Cache: 1. è®¡ç®—ç”¨æˆ·å†å² token<br/>ç”Ÿæˆ KV Cache
    Note over User,Cache: åªæ‰§è¡Œä¸€æ¬¡<br/>é«˜æ•ˆåˆ©ç”¨ KV Cache
    
    Cache->>Doc1: 2. å¹¿æ’­ç”¨æˆ· KV Cache
    Cache->>Doc2: 2. å¹¿æ’­ç”¨æˆ· KV Cache
    Cache->>Doc3: 2. å¹¿æ’­ç”¨æˆ· KV Cache
    
    Doc1->>Doc1: 3. Target1 + ç”¨æˆ·KV<br/>è®¡ç®— Attention
    Doc2->>Doc2: 3. Target2 + ç”¨æˆ·KV<br/>è®¡ç®— Attention
    Doc3->>Doc3: 3. Target3 + ç”¨æˆ·KV<br/>è®¡ç®— Attention
```

## æ— å‘ Self-Attention åŸç†

### **å®šä¹‰**

æ— å‘ Self-Attention æ˜¯ä¸€ç§**åŒå‘æ³¨æ„åŠ›æœºåˆ¶**ï¼Œå…è®¸æ¯ä¸ªä½ç½®çš„ token **çœ‹åˆ°åºåˆ—ä¸­çš„æ‰€æœ‰å…¶ä»–ä½ç½®**ã€‚

è¿™ä¸ BERT ç­‰åŒå‘æ¨¡å‹ç›¸åŒï¼Œæ²¡æœ‰ä»»ä½•å¯è§æ€§é™åˆ¶ã€‚

### **æ•°å­¦è¡¨ç¤º**

å¯¹äºä¸€ä¸ªé•¿åº¦ä¸º N çš„åºåˆ—ï¼Œæ— å‘ Self-Attention çš„å¯è§èŒƒå›´çŸ©é˜µä¸ºï¼š

```
     0    1    2    3    4
0 [  1    1    1    1    1  ]  â† ä½ç½®0ï¼šèƒ½çœ‹æ‰€æœ‰ä½ç½®
1 [  1    1    1    1    1  ]  â† ä½ç½®1ï¼šèƒ½çœ‹æ‰€æœ‰ä½ç½®
2 [  1    1    1    1    1  ]  â† ä½ç½®2ï¼šèƒ½çœ‹æ‰€æœ‰ä½ç½®
3 [  1    1    1    1    1  ]  â† ä½ç½®3ï¼šèƒ½çœ‹æ‰€æœ‰ä½ç½®
4 [  1    1    1    1    1  ]  â† ä½ç½®4ï¼šèƒ½çœ‹æ‰€æœ‰ä½ç½®

è§„åˆ™ï¼šæ¯ä¸ªä½ç½®éƒ½èƒ½çœ‹åˆ°æ‰€æœ‰ä½ç½®ï¼ˆåŒ…æ‹¬è‡ªå·±ï¼‰
```

### **åœ¨ Attention ä¸­çš„åº”ç”¨**

Self-Attention è®¡ç®—å…¬å¼ï¼š
```
Attention(Q, K, V) = softmax(QÂ·K^T / âˆšd) Â· V

å…¶ä¸­ï¼š
  - Q (Query)ï¼šæŸ¥è¯¢å‘é‡ï¼Œæ¥è‡ªå½“å‰ä½ç½®
  - K (Key)ï¼šé”®å‘é‡ï¼Œæ¥è‡ªæ‰€æœ‰ä½ç½®
  - V (Value)ï¼šå€¼å‘é‡ï¼Œæ¥è‡ªæ‰€æœ‰ä½ç½®
  - ä¸åŠ ä»»ä½• Maskï¼Œå¯è§å…¨éƒ¨ä½ç½®
```

**å…·ä½“ä¾‹å­**ï¼š

```
å‡è®¾åºåˆ—ä¸ºï¼š[Target_Item, User_History_1, User_History_2, User_History_3]
                   0             1               2              3

è®¡ç®—ä½ç½® 2 çš„ Attention æ—¶ï¼š
Q2 = Query at position 2

å¯è§ä½ç½®ï¼š
  âœ… ä½ç½®0 (Target_Item)ï¼šå¯è§
  âœ… ä½ç½®1 (User_History_1)ï¼šå¯è§
  âœ… ä½ç½®2 (User_History_2)ï¼šå¯è§ï¼ˆè‡ªå·±ï¼‰
  âœ… ä½ç½®3 (User_History_3)ï¼šå¯è§

Attention_weights = [0.2, 0.3, 0.3, 0.2]  â† æ‰€æœ‰ä½ç½®éƒ½æœ‰æƒé‡
```

### **æ— å‘ Attention çš„åº”ç”¨åœºæ™¯**

| åœºæ™¯ | ç‰¹ç‚¹ | ä¾‹å­ |
|------|------|------|
| **åˆ†ç±»ä»»åŠ¡** | éœ€è¦å®Œæ•´ä¸Šä¸‹æ–‡ | BERTã€æ–‡æœ¬åˆ†ç±» |
| **ç¼–ç å™¨** | åŒå‘ç†è§£ | Transformer Encoder |
| **æ¨èæ’åº** | ç›¸äº’ä¾èµ–å…³ç³» | LONGERï¼ˆæ— å‘ç‰ˆæœ¬ï¼‰ |
| **ç‰¹å¾æå–** | å…¨å±€ç‰¹å¾èåˆ | å›¾åƒç‰¹å¾èåˆ |

## ä¼˜åŒ–æ ¸å¿ƒæœºåˆ¶

### **ä¸ºä»€ä¹ˆå¯ä»¥ä¼˜åŒ–ï¼Ÿ**

```mermaid
graph TB
    A["æ— å‘ Self-Attention"] --> B["User Tokens å½¼æ­¤å¯è§"]
    B --> C["User ä¹‹é—´çš„ Attention å…³ç³»<br/>ç‹¬ç«‹äº Target Item çš„é€‰æ‹©"]
    C --> D["âœ… User ç²’åº¦ KV Cache<br/>å¯ä»¥ç‹¬ç«‹è®¡ç®—ä¸€æ¬¡"]
    
    E["å¤šä¸ª Target Items<br/>éœ€è¦æ’åº"] --> F["ä¸åŒçš„ Target Items<br/>åªéœ€ä¸ User History èåˆ"]
    F --> G["âœ… KV Cache å¯ä»¥<br/>å¹¿æ’­åˆ°æ‰€æœ‰ Docs"]
    
    D --> H["æ•ˆæœï¼šååé™å¹…<br/>ä» 40% â†’ 6.8%"]
    G --> H
```

### **æ³¨æ„åŠ›è®¡ç®—æµç¨‹**

```mermaid
graph TB
    subgraph User["User ç²’åº¦è®¡ç®—ï¼ˆå…±äº«ï¼‰"]
        U1["User_History_1"]
        U2["User_History_2"]
        U3["User_History_3"]
        
        U1 --- U2
        U2 --- U3
        U1 --- U3
        
        style U1 fill:#99ccff
        style U2 fill:#99ccff
        style U3 fill:#99ccff
    end
    
    subgraph Doc["Doc ç²’åº¦èåˆ"]
        T1["Target_1"]
        T2["Target_2"]
        T3["Target_3"]
        
        T1 --- U1
        T1 --- U2
        T1 --- U3
        
        T2 --- U1
        T2 --- U2
        T2 --- U3
        
        T3 --- U1
        T3 --- U2
        T3 --- U3
        
        style T1 fill:#ff99cc
        style T2 fill:#ff99cc
        style T3 fill:#ff99cc
    end
    
    Cache1["KV Cache<br/>å¤ç”¨"]
    Cache2["KV Cache<br/>å¤ç”¨"]
    Cache3["KV Cache<br/>å¤ç”¨"]
    
    U1 -.->|å…±äº«| Cache1
    Cache1 -.->|å¹¿æ’­| T1
    Cache1 -.->|å¹¿æ’­| T2
    Cache1 -.->|å¹¿æ’­| T3
```

### **ä¸ºä»€ä¹ˆè¿™ä¸ªä¼˜åŒ–æœ‰æ•ˆï¼Ÿ**

```
å…³é”®è§‚å¯Ÿï¼š
â”œâ”€ User Tokens ä¹‹é—´çš„ç›¸äº’å…³ç³»ï¼ˆUser ç²’åº¦ KV è®¡ç®—ï¼‰
â”‚  â””â”€ ä¸ä¾èµ–äºå…·ä½“é€‰æ‹©äº†å“ªä¸ª Target Item
â”‚
â”œâ”€ Target Item ä¸ User Tokens çš„å…³ç³»ï¼ˆDoc ç²’åº¦èåˆï¼‰
â”‚  â””â”€ åªéœ€è¦ä¸€æ¬¡ Attention è®¡ç®—
â”‚
â””â”€ ç»“è®ºï¼š
   â”œâ”€ User ç²’åº¦çš„ KV Cache å¯ä»¥é‡å¤ä½¿ç”¨ N æ¬¡ï¼ˆN ä¸ª Target Itemsï¼‰
   â”œâ”€ å‡å°‘äº† N-1 æ¬¡é‡å¤çš„ User Attention è®¡ç®—
   â””â”€ ååé‡å¤§å¹…æå‡
```

## æ€§èƒ½æå‡æ•°æ®

| æŒ‡æ ‡ | ä¼ ç»Ÿæ–¹æ¡ˆ | ä¼˜åŒ–æ–¹æ¡ˆ | æ”¹è¿› |
|------|--------|--------|------|
| **æ¨ç†ååé™å¹…** | 40% | 6.8% | â†“33.2% |
| **åºåˆ—å¢é•¿æ—¶** | çº¿æ€§æ¶åŒ– | å‡ ä¹æ— å½±å“ | â¬†ï¸ æ˜¾è‘— |
| **æ˜¾å­˜å‹åŠ›** | æ¯ä¸ª Doc ç‹¬ç«‹ | å…±äº« KV Cache | å‡å°‘ N å€ |

## é˜Ÿåˆ—é•¿åº¦å¯¹æ€§èƒ½æå‡çš„å½±å“åˆ†æ

é˜Ÿåˆ—é•¿åº¦ï¼ˆå€™é€‰å•†å“æ•°é‡ Nï¼‰è¶Šå¤§ï¼Œæ€§èƒ½æå‡è¶Šæ˜¾è‘—ã€‚

### **ä¸åŒé˜Ÿåˆ—é•¿åº¦çš„æ€§èƒ½æ•°æ®**

| é˜Ÿåˆ—é•¿åº¦ | æ€§èƒ½æå‡ | ååé™å¹… | è¯´æ˜ |
|---------|--------|--------|------|
| N=1 | 0% | 40% | âŒ æ— æ³•ä¼˜åŒ– |
| N=5 | 68% | 13% | âš ï¸ å°è§„æ¨¡ |
| N=10 | 76% | 9.4% | âœ… ä¸­ç­‰ |
| N=50 | 83% | 6.8% | âœ…âœ… å…¸å‹åœºæ™¯ |
| N=100 | 84% | 6.4% | âœ…âœ… å¤§è§„æ¨¡ |
| Nâ†’âˆ | ~85% | ~6% | ğŸ“ˆ æé™å€¼ |

### **æ ¸å¿ƒè§„å¾‹**

```
ä¼˜åŒ–åŸç†ï¼š
  ä¼ ç»Ÿæ–¹æ¡ˆï¼šæ¯ä¸ª Target Item éƒ½è®¡ç®—ä¸€æ¬¡ User Attention
  ä¼˜åŒ–æ–¹æ¡ˆï¼šUser Attention è®¡ç®—ä¸€æ¬¡ï¼ŒN ä¸ª Target Item å…±äº«

æ€§èƒ½æå‡ â‰ˆ (N-1) / N Ã— 85%

å…³é”®ç»“è®ºï¼š
  â€¢ N â‰¥ 50 æ—¶ï¼Œæ€§èƒ½æå‡ç¨³å®šåœ¨ 83% ä»¥ä¸Š
  â€¢ æ¨èæ’åºé˜Ÿåˆ—ï¼ˆN=50-200ï¼‰æœ€é€‚åˆæ­¤ä¼˜åŒ–
  â€¢ å•ä¸ªé¢„æµ‹ï¼ˆN=1ï¼‰æ— æ³•ä¼˜åŒ–
```

### **åº”ç”¨å»ºè®®**

| åœºæ™¯ | é˜Ÿåˆ—é•¿åº¦ | æ¨èåº¦ |
|------|--------|--------|
| ç²¾æ’ï¼ˆå•ä¸ªå•†å“ï¼‰ | N=1 | âŒ ä¸é€‚ç”¨ |
| å°è§„æ¨¡å€™é€‰ | N=5-10 | âš ï¸ ä¸­ç­‰ |
| æ ‡å‡†é‡æ’åº | N=50-100 | âœ…âœ… å¼ºçƒˆæ¨è |
| å¤§è§„æ¨¡æ¨è | N=200+ | âœ…âœ… æœ€ä¼˜

## å…³é”®ä¼˜åŒ–ç‚¹æ€»ç»“

1. âœ… **è¯†åˆ«ç‹¬ç«‹è®¡ç®—ç©ºé—´**ï¼šUser ç²’åº¦çš„ token è®¡ç®—å½¼æ­¤ç‹¬ç«‹
2. âœ… **å‡å°‘å†—ä½™è®¡ç®—**ï¼šå¤šä¸ª Target Item ä¸é‡å¤è®¡ç®—ç”¨æˆ·å†å²
3. âœ… **KV Cache å¤ç”¨**ï¼šä¸€ä»½ User KV Cacheï¼Œå¹¿æ’­ç»™æ‰€æœ‰ Doc
4. âœ… **æ˜¾å­˜ä¼˜åŒ–**ï¼šé¿å… N ä»½ç›¸åŒçš„ KV Cache å­˜å‚¨
